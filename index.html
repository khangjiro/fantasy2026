<script>
const LEAGUE_ID = 145810;
const BASE_API = `https://fantasy.premierleague.com/api/leagues-classic/${LEAGUE_ID}/standings/`;
const PROXY = "https://corsproxy.io/?";
const GW_START = 20;

// Lấy toàn bộ thành viên qua nhiều trang
async function getAllMembers() {
  let members = [];
  let page = 1;
  let hasMore = true;
  while (hasMore) {
    const res = await fetch(PROXY + `${BASE_API}?page_standings=${page}`);
    const data = await res.json();
    if (data.standings && data.standings.results.length > 0) {
      members = members.concat(data.standings.results);
      hasMore = data.standings.has_next;
      page++;
    } else {
      hasMore = false;
    }
  }
  return members;
}

// Lấy tổng điểm GW20+ cho từng thành viên
async function getGW20Plus(entry) {
  try {
    const res = await fetch(PROXY + `https://fantasy.premierleague.com/api/entry/${entry}/history/`);
    const history = await res.json();
    const gw20plus = history.current.filter(gw => gw.event >= GW_START);
    return gw20plus.reduce((sum, gw) => sum + gw.points, 0);
  } catch {
    return "N/A";
  }
}

(async () => {
  const members = await getAllMembers(); // Lấy hết thành viên!
  const gwPointPromises = members.map(member => getGW20Plus(member.entry));
  const gwPoints = await Promise.all(gwPointPromises);

  // Hiển thị bảng
  const rows = members.map((member, i) => `
    <tr>
      <td>${member.rank}</td>
      <td>${member.entry_name}</td>
      <td>${member.player_name}</td>
      <td>${gwPoints[i]}</td>
    </tr>
  `).join("");
  document.getElementById("standings").innerHTML = rows;
})();
</script>
