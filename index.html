<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FPL League Standings (GW20+)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; background: #fff; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #37003c; color: white; cursor:pointer; }
    .loading { color: #37003c; }
    .sorted { background: #570066; }
    .total { font-weight: bold; }
  </style>
</head>
<body>
  <h1>FPL League Standings (GW20+)</h1>
  <table>
    <thead id="thead"></thead>
    <tbody id="standings">
      <tr><td colspan="99" class="loading">Loading...</td></tr>
    </tbody>
  </table>
  <script>
    // Proxy công cộng (chỉ dùng tạm)
    const PROXY = "https://corsproxy.io/?";
    const LEAGUE_ID = 145810;
    const BASE_API = `https://fantasy.premierleague.com/api/leagues-classic/${LEAGUE_ID}/standings/`;
    const GW_START = 20;

    let members = [];
    let histories = [];
    let weeks = [];
    let sortCol = null;
    let sortDir = 1; // 1: asc, -1: desc

    async function getAllMembers() {
      let result = [];
      let page = 1;
      let hasMore = true;
      while (hasMore) {
        const res = await fetch(PROXY + encodeURIComponent(`${BASE_API}?page_standings=${page}`));
        const data = await res.json();
        if (data.standings && data.standings.results.length > 0) {
          result = result.concat(data.standings.results);
          hasMore = data.standings.has_next;
          page++;
        } else {
          hasMore = false;
        }
      }
      return result;
    }

    async function getMemberHistory(entry) {
      try {
        const res = await fetch(PROXY + encodeURIComponent(`https://fantasy.premierleague.com/api/entry/${entry}/history/`));
        const history = await res.json();
        return history.current; // array of gw objects
      } catch {
        return [];
      }
    }

    function getAvailableWeeks(histories) {
      const gwSet = new Set();
      histories.forEach(his => his.forEach(gw => {
        if (gw.event >= GW_START) gwSet.add(gw.event);
      }));
      const weeks = Array.from(gwSet).sort((a,b) => a-b);
      return weeks;
    }

    function renderTable() {
      // Header
      let theadHTML = `
        <tr>
          <th data-sort="rank">Rank</th>
          <th data-sort="team">Team</th>
          <th data-sort="manager">Manager</th>
          <th data-sort="totalAll">Total (all GW)</th>
      `;
      weeks.forEach(w => {
        theadHTML += `<th data-sort="gw${w}">GW${w}</th>`;
      });
      theadHTML += `<th data-sort="totalGW20plus">Total GW${GW_START}+</th></tr>`;
      document.getElementById("thead").innerHTML = theadHTML;

      // Tính điểm từng tuần/tổng cho tất cả member
      let dataTable = members.map((member, i) => {
        const history = histories[i];
        const totalAll = history.reduce((sum, gw) => sum + gw.points, 0);
        const totalGW20plus = history.filter(gw => gw.event >= GW_START)
                                     .reduce((sum, gw) => sum + gw.points, 0);
        const gwPoints = weeks.map(w => {
          const gw = history.find(gw => gw.event === w);
          return gw ? gw.points : '';
        });
        return {
          rank: member.rank,
          team: member.entry_name,
          manager: member.player_name,
          totalAll,
          gwPoints,
          totalGW20plus
        };
      });

      // Sort nếu đã chọn cột
      if (sortCol) {
        dataTable.sort((a, b) => {
          let va, vb;
          if (sortCol.startsWith('gw')) {
            const idx = weeks.indexOf(Number(sortCol.slice(2)));
            va = a.gwPoints[idx] || 0;
            vb = b.gwPoints[idx] || 0;
          } else {
            va = a[sortCol];
            vb = b[sortCol];
          }
          return (va === '' ? -1 : vb === '' ? 1 : va - vb) * sortDir;
        });
      }

      // Body
      const rows = dataTable.map(row => `
        <tr>
          <td>${row.rank}</td>
          <td>${row.team}</td>
          <td>${row.manager}</td>
          <td class="total">${row.totalAll}</td>
          ${row.gwPoints.map(pt => `<td>${pt}</td>`).join('')}
          <td class="total">${row.totalGW20plus}</td>
        </tr>
      `).join("");
      document.getElementById("standings").innerHTML = rows;

      // Thêm sự kiện sort cho các thẻ th
      document.querySelectorAll("thead th[data-sort]").forEach(th => {
        th.onclick = function() {
          const col = th.getAttribute("data-sort");
          if (sortCol === col) sort
