<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FPL League GW20+</title>
    <style>
      body { font-family: Arial; background: #f4f6f8; padding: 20px; }
      h1 { text-align: center; }
      table { width: 100%; border-collapse: collapse; background: #fff; }
      th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
      th { background: #37003c; color: white; }
      .loading { color: #37003c; }
    </style>
  </head>
  <body>
    <h1>FPL League Standings (GW20+)</h1>
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>Team</th>
          <th>Manager</th>
          <th>Total Points GW20+</th>
        </tr>
      </thead>
      <tbody id="standings"></tbody>
    </table>

    <script>
      const API_URL = "https://fantasy.premierleague.com/api/leagues-classic/145810/standings/";
      const PROXY = "https://corsproxy.io/?";

      // Hiển thị loading
      document.getElementById("standings").innerHTML = "<tr><td colspan='4' class='loading'>Loading...</td></tr>";

      fetch(PROXY + API_URL)
        .then((res) => res.json())
        .then(async (data) => {
          const teams = data.standings.results;
          // Chỉ lấy tối đa 10 team để demo cho nhanh
          const teamsToShow = teams.slice(0, 10);

          // Lấy tổng điểm GW 20+
          const gwPromises = teamsToShow.map(team =>
            fetch(PROXY + `https://fantasy.premierleague.com/api/entry/${team.entry}/history/`)
              .then(res => res.json())
              .then(history => {
                // Lọc các gameweek >= 20 và cộng lại
                const gw20plus = history.current.filter(gw => gw.event >= 20);
                const totalGW20plus = gw20plus.reduce((sum, gw) => sum + gw.points, 0);
                return totalGW20plus;
              })
              .catch(() => 'N/A')
          );

          const gwPoints = await Promise.all(gwPromises);

          // Render bảng
          const rows = teamsToShow.map((team, i) => `
              <tr>
                <td>${team.rank}</td>
                <td>${team.entry_name}</td>
                <td>${team.player_name}</td>
                <td>${gwPoints[i]}</td>
              </tr>
            `
          ).join("");
          document.getElementById("standings").innerHTML = rows;
        })
        .catch((err) => {
          document.getElementById("standings").innerHTML =
            "<tr><td colspan='4'>Failed to load data</td></tr>";
          console.error(err);
        });
    </script>
  </body>
</html>
