<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FPL League Standings</title>
    <style>
      body { font-family: Arial; background: #f4f6f8; padding: 20px; }
      h1 { text-align: center; }
      table { width: 100%; border-collapse: collapse; background: #fff; }
      th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
      th { background: #37003c; color: white; }
      .loading { color: #37003c; }
    </style>
  </head>
  <body>
    <h1>FPL League Standings</h1>
    <table>
      <thead>
        <tr>
          <th>Rank</th>
          <th>Team</th>
          <th>Manager</th>
          <th>Total Points</th>
          <th>GW Points</th>
        </tr>
      </thead>
      <tbody id="standings"></tbody>
    </table>

    <script>
      const API_URL = "https://fantasy.premierleague.com/api/leagues-classic/145810/standings/";
      const PROXY = "https://corsproxy.io/?";

      // Hiển thị loading
      document.getElementById("standings").innerHTML = "<tr><td colspan='5' class='loading'>Loading...</td></tr>";

      fetch(PROXY + API_URL)
        .then((res) => res.json())
        .then(async (data) => {
          const teams = data.standings.results;

          // Chỉ lấy tối đa 10 team để demo, lấy nhiều thì chậm
          const teamsToShow = teams.slice(0, 10);

          // Lấy điểm GW mới nhất cho từng team
          const gwPromises = teamsToShow.map(team =>
            fetch(PROXY + `https://fantasy.premierleague.com/api/entry/${team.entry}/history/`)
              .then(res => res.json())
              .then(history => {
                const latestGW = history.current[history.current.length - 1];
                return latestGW ? latestGW.points : 'N/A';
              })
              .catch(() => 'N/A')
          );

          const gwPoints = await Promise.all(gwPromises);

          // Render bảng
          const rows = teamsToShow.map((team, i) => `
              <tr>
                <td>${team.rank}</td>
                <td>${team.entry_name}</td>
                <td>${team.player_name}</td>
                <td>${team.total}</td>
                <td>${gwPoints[i]}</td>
              </tr>
            `
          ).join("");
          document.getElementById("standings").innerHTML = rows;
        })
        .catch((err) => {
          document.getElementById("standings").innerHTML =
            "<tr><td colspan='5'>Failed to load data</td></tr>";
          console.error(err);
        });
    </script>
  </body>
</html>
